<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:PIM4App.ViewModels"
             xmlns:dto="clr-namespace:PIM4App.DTO"
             xmlns:converters="clr-namespace:PIM4App.Converters"
             x:DataType="vm:DetalheTecnicoViewModel"
             x:Class="PIM4App.Views.DetalheTecnicoPage"
             Title="Detalhes do Chamado"
             BackgroundColor="#f4f4f9">
    <!-- Fundo cinza claro igual Web -->

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:StatusConverter x:Key="StatusConverter" />
            <converters:StatusColorConverter x:Key="StatusColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*, Auto">

        <ScrollView Grid.Row="0">
            <VerticalStackLayout Padding="20" Spacing="20">

                <!-- CABEÇALHO DO CHAMADO -->
                <Frame BackgroundColor="White" Padding="20" CornerRadius="15" HasShadow="True" BorderColor="Transparent">
                    <VerticalStackLayout Spacing="8">
                        <Label Text="TÍTULO" FontSize="11" TextColor="#777" FontAttributes="Bold"/>
                        <Label Text="{Binding Chamado.Titulo}" FontSize="22" FontAttributes="Bold" TextColor="#311e6f"/>

                        <BoxView HeightRequest="1" Color="#EEE" Margin="0,5"/>

                        <Grid ColumnDefinitions="*,*">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="STATUS" FontSize="11" TextColor="#777" FontAttributes="Bold"/>
                                <!-- AQUI A MÁGICA: Usa o Converter para mostrar texto e cor -->
                                <Label Text="{Binding Chamado.IdStatus, Converter={StaticResource StatusConverter}}" 
                                       TextColor="{Binding Chamado.IdStatus, Converter={StaticResource StatusColorConverter}}" 
                                       FontSize="16" FontAttributes="Bold"/>
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Column="1">
                                <Label Text="DATA" FontSize="11" TextColor="#777" FontAttributes="Bold"/>
                                <Label Text="{Binding Chamado.DataAbertura, StringFormat='{0:dd/MM/yyyy}'}" FontSize="16" TextColor="#333"/>
                            </VerticalStackLayout>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- DESCRIÇÃO -->
                <Frame BackgroundColor="White" Padding="20" CornerRadius="15" HasShadow="True" BorderColor="Transparent">
                    <VerticalStackLayout Spacing="8">
                        <Label Text="DESCRIÇÃO DO PROBLEMA" FontSize="11" TextColor="#777" FontAttributes="Bold"/>
                        <Label Text="{Binding Chamado.Descricao}" FontSize="15" TextColor="#444" LineHeight="1.2"/>
                    </VerticalStackLayout>
                </Frame>

                <!-- HISTÓRICO -->
                <Label Text="Histórico e Comentários" FontAttributes="Bold" FontSize="16" TextColor="#311e6f" Margin="0,10,0,0"/>

                <CollectionView ItemsSource="{Binding Interacoes}" EmptyView="Nenhum comentário ainda.">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="10"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="dto:InteracaoDTO">
                            <Frame BackgroundColor="White" Padding="15" CornerRadius="10" HasShadow="False" BorderColor="#E0E0E0">
                                <VerticalStackLayout Spacing="4">
                                    <FlexLayout JustifyContent="SpaceBetween">
                                        <Label Text="{Binding IdAutor, StringFormat='Usuário ID {0}'}" FontAttributes="Bold" FontSize="12" TextColor="#764dfc"/>
                                        <Label Text="{Binding DataInteracao, StringFormat='{0:HH:mm - dd/MM}'}" TextColor="#999" FontSize="11"/>
                                    </FlexLayout>
                                    <Label Text="{Binding Mensagem}" FontSize="14" TextColor="#333"/>
                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Espaço extra para não ficar atrás da caixa de input -->
                <BoxView HeightRequest="20" Color="Transparent"/>

            </VerticalStackLayout>
        </ScrollView>

        <!-- RODAPÉ: AÇÕES E COMENTÁRIO -->
        <Frame Grid.Row="1" Padding="15" BackgroundColor="White" CornerRadius="20" HasShadow="True" BorderColor="#EEE" Margin="0,0,0,-10">
            <VerticalStackLayout Spacing="15">

                <!-- Botões de Ação (Só aparecem se não estiver finalizado) -->
                <Grid ColumnDefinitions="*, *" ColumnSpacing="10">
                    <Button Grid.Column="0" Text="Assumir" 
                            Command="{Binding AssumirCommand}"
                            BackgroundColor="#764dfc" 
                            IsEnabled="{Binding IsNotBusy}"
                            HeightRequest="45" CornerRadius="10"/>

                    <Button Grid.Column="1" Text="Finalizar" 
                            Command="{Binding FinalizarCommand}"
                            BackgroundColor="#2ecc71" 
                            IsEnabled="{Binding IsNotBusy}"
                            HeightRequest="45" CornerRadius="10"/>
                </Grid>

                <!-- Input de Comentário -->
                <Grid ColumnDefinitions="*, Auto" ColumnSpacing="10">
                    <Frame Grid.Column="0" Padding="0" CornerRadius="10" BorderColor="#DDD" HasShadow="False" BackgroundColor="#FAFAFA">
                        <Entry Placeholder="Escreva um comentário..." 
                               Text="{Binding NovoComentario}" 
                               IsEnabled="{Binding IsNotBusy}"
                               Margin="10,0"/>
                    </Frame>

                    <Button Grid.Column="1" Text="➤" 
                            Command="{Binding AdicionarComentarioCommand}"
                            WidthRequest="50" HeightRequest="50" CornerRadius="25"
                            BackgroundColor="#311e6f"
                            IsEnabled="{Binding IsNotBusy}"/>
                </Grid>

            </VerticalStackLayout>
        </Frame>

    </Grid>

</ContentPage>